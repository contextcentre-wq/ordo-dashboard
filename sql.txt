WITH ad_active_periods AS (
    -- Определяем период активности для каждого объявления (без изменений)
    SELECT
        ad_id,
        channel,
        MIN(date) AS first_active_date,
        MAX(date) AS last_active_date
    FROM ad_stats
    GROUP BY ad_id, channel
),

ads_with_metrics AS (
    -- Получаем данные эффективности рекламы с метриками (без изменений)
    SELECT
        ap.date,
        ap.channel,
        ap.account_id,
        ap.account_name,
        ap.campaign_name,
        ap.adset_name,
        ap.ad_id,
        ap.ad_name,
        ap.impressions,
        ap.clicks,
        ap.spend,
        ap.leads,
        ap.whatsapp_requests,
        ap.appointments_scheduled,
        ap.treatments_completed,
        ap.plans_sent,
        -- Расчет метрик
        CASE WHEN ap.impressions > 0 THEN (ap.clicks::float / ap.impressions) * 100 ELSE 0 END AS ctr,
        CASE WHEN ap.clicks > 0 THEN ap.spend / ap.clicks ELSE 0 END AS cpc,
        CASE WHEN ap.leads > 0 THEN ap.spend / ap.leads ELSE 0 END AS cpl,
        CASE WHEN ap.leads > 0 THEN (ap.appointments_scheduled::float / ap.leads) * 100 ELSE 0 END AS cv_to_appointment
    FROM ad_stats ap
),

-- Упрощенный CTE для вычисления даты последней продажи для каждого объявления
-- ОСТАВЛЯЕМ по date для подсчета дней
last_sales_dates AS (
    SELECT
        ad_id,
        MAX(date) AS last_sale_date
    FROM sales
    WHERE ad_id IS NOT NULL
    GROUP BY ad_id
),

-- Основная логика атрибуции - ИЗМЕНЕНО: сопоставление по registration
sales_attributed_by_registration AS (
    SELECT
        ap.date,
        ap.ad_id,
        ap.channel,
        -- Суммы продаж, привязанные к дате регистрации (registration)
        COALESCE(SUM(s.amount) FILTER (
            WHERE s.ad_id = ap.ad_id AND (
                -- ИЗМЕНЕНО: продажи привязываются к дате регистрации (s.registration)
                DATE(s.registration) = ap.date
            )
        ), 0) AS sales_amount,
        
        -- Количество продаж, привязанное к дате регистрации
        COUNT(s.id) FILTER (
            WHERE s.ad_id = ap.ad_id AND (
                DATE(s.registration) = ap.date
            )
        ) AS sales_count,
        
        -- Поздние продажи учитываются только если объявление уже не активно
        COALESCE(SUM(s.amount) FILTER (
            WHERE s.ad_id = ap.ad_id AND 
            (ap.date = aap.last_active_date) AND
            (DATE(s.registration) > ap.date) AND
            -- Добавляем ограничение по времени, чтобы не учитывать слишком старые сделки
            (DATE(s.registration) <= ap.date + interval '7 day')
        ), 0) AS late_sales_amount,
        
        COUNT(s.id) FILTER (
            WHERE s.ad_id = ap.ad_id AND 
            (ap.date = aap.last_active_date) AND
            (DATE(s.registration) > ap.date) AND
            (DATE(s.registration) <= ap.date + interval '7 day')
        ) AS late_sales_count,
        
        -- Массивы с информацией о сделках - привязаны к датам регистрации
        array_agg(s.deal_link) FILTER (
            WHERE s.ad_id = ap.ad_id AND 
            (
                DATE(s.registration) = ap.date OR
                ((ap.date = aap.last_active_date) AND (DATE(s.registration) > ap.date) AND (DATE(s.registration) <= ap.date + interval '7 day'))
            ) AND 
            s.deal_link IS NOT NULL
        ) AS deal_links,
        
        array_agg(s.client_name) FILTER (
            WHERE s.ad_id = ap.ad_id AND 
            (
                DATE(s.registration) = ap.date OR
                ((ap.date = aap.last_active_date) AND (DATE(s.registration) > ap.date) AND (DATE(s.registration) <= ap.date + interval '7 day'))
            ) AND 
            s.client_name IS NOT NULL
        ) AS client_names,
        
        array_agg(s.deal_status) FILTER (
            WHERE s.ad_id = ap.ad_id AND 
            (
                DATE(s.registration) = ap.date OR
                ((ap.date = aap.last_active_date) AND (DATE(s.registration) > ap.date) AND (DATE(s.registration) <= ap.date + interval '7 day'))
            ) AND 
            s.deal_status IS NOT NULL
        ) AS deal_statuses,
        
        -- Флаг, был ли это последний день активности
        CASE WHEN ap.date = aap.last_active_date THEN true ELSE false END AS is_last_active_day,
        
        -- JSON с данными по сделкам
        json_agg(json_build_object(
            'client', s.client_name,
            'amount', s.amount,
            'status', s.deal_status,
            'link', s.deal_link,
            'date', s.date,
            'created_at', s.created_at,
            'registration', s.registration,
            'updated_at', s.updated_at,
            'is_late_sale', CASE 
                WHEN (ap.date = aap.last_active_date) AND (DATE(s.registration) > ap.date) 
                THEN true ELSE false 
            END
        )) FILTER (
            WHERE s.ad_id = ap.ad_id AND 
            (
                DATE(s.registration) = ap.date OR
                ((ap.date = aap.last_active_date) AND (DATE(s.registration) > ap.date) AND (DATE(s.registration) <= ap.date + interval '7 day'))
            )
        ) AS sales_details
    FROM ads_with_metrics ap
    JOIN ad_active_periods aap ON ap.ad_id = aap.ad_id AND ap.channel = aap.channel
    LEFT JOIN sales s ON ap.ad_id = s.ad_id
    GROUP BY ap.date, ap.ad_id, ap.channel, aap.last_active_date
)

-- Финальный запрос - объединяем все метрики и добавляем новые колонки
SELECT
    am.*,
    COALESCE(sa.sales_amount, 0) + COALESCE(sa.late_sales_amount, 0) AS sales_amount,
    COALESCE(sa.sales_count, 0) + COALESCE(sa.late_sales_count, 0) AS sales_count,
    sa.deal_links,
    sa.client_names,
    sa.deal_statuses,
    sa.is_last_active_day,
    sa.late_sales_amount,
    sa.late_sales_count,
    sa.sales_details,
    -- Расчет ROMI на уровне объявления
    CASE 
        WHEN am.spend > 0 THEN 
            ((COALESCE(sa.sales_amount, 0) + COALESCE(sa.late_sales_amount, 0)) / am.spend) * 100
        ELSE 0 
    END AS romi,
    -- Добавляем дату последней продажи (по date - фактическая дата продажи)
    lsd.last_sale_date,
    -- Вычисляем количество дней с последней продажи по фактической дате продажи
    CASE
        WHEN lsd.last_sale_date IS NOT NULL THEN (CURRENT_DATE - lsd.last_sale_date)
        ELSE NULL
    END AS days_since_last_sale
FROM ads_with_metrics am
LEFT JOIN sales_attributed_by_registration sa ON am.ad_id = sa.ad_id AND am.date = sa.date AND am.channel = sa.channel
LEFT JOIN last_sales_dates lsd ON am.ad_id = lsd.ad_id
ORDER BY am.date DESC, am.channel, am.campaign_name, am.adset_name, am.ad_name;